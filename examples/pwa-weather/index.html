<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KPIO Weather</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196F3">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #2196F3, #1565C0);
      color: white; min-height: 100vh;
    }
    header {
      padding: 16px; display: flex; justify-content: space-between; align-items: center;
    }
    header h1 { font-size: 18px; }
    #install-btn {
      background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4);
      padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 13px;
      display: none;
    }
    .container { max-width: 480px; margin: 0 auto; padding: 16px; }
    .city-select {
      width: 100%; padding: 10px; border-radius: 8px; border: none;
      font-size: 14px; margin-bottom: 16px;
    }
    .weather-card {
      background: rgba(255,255,255,0.15); border-radius: 16px;
      padding: 24px; text-align: center; backdrop-filter: blur(10px);
    }
    .weather-card .temp { font-size: 64px; font-weight: 200; }
    .weather-card .desc { font-size: 16px; opacity: 0.8; margin-top: 4px; }
    .weather-card .details {
      display: flex; justify-content: space-around; margin-top: 20px;
      font-size: 13px; opacity: 0.7;
    }
    .weather-card .city-name { font-size: 22px; font-weight: 500; }
    .notify-btn {
      display: block; width: 100%; margin-top: 16px; padding: 12px;
      background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px; font-size: 14px; cursor: pointer;
    }
    .notify-btn:hover { background: rgba(255,255,255,0.3); }
    .offline-banner {
      display: none; background: #FF9800; color: white; text-align: center;
      padding: 8px; font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="offline-banner" id="offline-banner">ì˜¤í”„ë¼ì¸ ëª¨ë“œ â€” ìºì‹œëœ ë°ì´í„° í‘œì‹œ ì¤‘</div>
  <header>
    <h1>ğŸŒ¤ KPIO Weather</h1>
    <button id="install-btn">ì„¤ì¹˜</button>
  </header>
  <div class="container">
    <select class="city-select" id="city-select" onchange="loadWeather()">
      <option value="seoul">ì„œìš¸</option>
      <option value="busan">ë¶€ì‚°</option>
      <option value="jeju">ì œì£¼</option>
      <option value="incheon">ì¸ì²œ</option>
      <option value="daejeon">ëŒ€ì „</option>
    </select>

    <div class="weather-card" id="weather-card">
      <div class="city-name" id="city-name">ì„œìš¸</div>
      <div class="temp" id="temp">--Â°</div>
      <div class="desc" id="desc">ë¡œë”© ì¤‘...</div>
      <div class="details">
        <div>ğŸ’§ ìŠµë„ <span id="humidity">--%</span></div>
        <div>ğŸŒ¬ í’ì† <span id="wind">--m/s</span></div>
        <div>ğŸŒ¡ ì²´ê° <span id="feels">--Â°</span></div>
      </div>
    </div>

    <button class="notify-btn" onclick="enableNotifications()">
      ğŸ”” ê¸°ì˜¨ ë³€í™” ì•Œë¦¼ ë°›ê¸°
    </button>
  </div>

  <script>
    // Mock weather data (since we can't access real APIs in KPIO OS)
    const MOCK_WEATHER = {
      seoul:   { name: 'ì„œìš¸',   temp: 22, feels: 20, humidity: 55, wind: 3.2, desc: 'ë§‘ìŒ â˜€ï¸' },
      busan:   { name: 'ë¶€ì‚°',   temp: 25, feels: 24, humidity: 65, wind: 4.1, desc: 'êµ¬ë¦„ ì¡°ê¸ˆ â›…' },
      jeju:    { name: 'ì œì£¼',   temp: 27, feels: 28, humidity: 72, wind: 5.5, desc: 'íë¦¼ â˜ï¸' },
      incheon: { name: 'ì¸ì²œ',   temp: 21, feels: 19, humidity: 58, wind: 3.8, desc: 'ë§‘ìŒ â˜€ï¸' },
      daejeon: { name: 'ëŒ€ì „',   temp: 24, feels: 23, humidity: 50, wind: 2.5, desc: 'ë§‘ìŒ â˜€ï¸' }
    };

    function loadWeather() {
      const city = document.getElementById('city-select').value;

      // Simulate fetch (in real app, this would be a network request)
      const data = MOCK_WEATHER[city];
      if (!data) return;

      // Slight random variation to simulate live data
      const variation = (Math.random() - 0.5) * 4;
      const temp = Math.round(data.temp + variation);

      document.getElementById('city-name').textContent = data.name;
      document.getElementById('temp').textContent = temp + 'Â°';
      document.getElementById('desc').textContent = data.desc;
      document.getElementById('humidity').textContent = data.humidity + '%';
      document.getElementById('wind').textContent = data.wind + 'm/s';
      document.getElementById('feels').textContent = Math.round(data.feels + variation) + 'Â°';

      // Cache the result
      localStorage.setItem('kpio_weather_last_' + city, JSON.stringify({
        ...data, temp, timestamp: Date.now()
      }));
    }

    function enableNotifications() {
      if ('Notification' in window) {
        Notification.requestPermission().then(perm => {
          if (perm === 'granted') {
            new Notification('KPIO Weather', {
              body: 'ê¸°ì˜¨ ë³€í™” ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.',
              icon: 'icon-192.png'
            });
          }
        });
      }
    }

    // Offline detection
    window.addEventListener('online', () => {
      document.getElementById('offline-banner').style.display = 'none';
      loadWeather();
    });
    window.addEventListener('offline', () => {
      document.getElementById('offline-banner').style.display = 'block';
    });

    // SW registration + background sync
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(reg => {
        if ('sync' in reg) {
          // Register periodic weather sync
          reg.sync.register('weather-sync').catch(() => {});
        }
      }).catch(() => {});
    }

    // Install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('install-btn').style.display = 'block';
    });
    document.getElementById('install-btn').addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        document.getElementById('install-btn').style.display = 'none';
      }
    });

    loadWeather();
  </script>
</body>
</html>
